#!/usr/bin/env bash
# Run nginx as nginx user and listen on port 8080

set -e

mkdir -p /run/nginx /var/cache/nginx /var/log/nginx
chown -R nginx:nginx /run/nginx /var/cache/nginx /var/log/nginx

sed -i 's/^[[:space:]]*user[[:space:]].*;/user nginx;/' /etc/nginx/nginx.conf

if grep -q '^pid' /etc/nginx/nginx.conf; then
  sed -i 's|^pid .*;|pid /run/nginx/nginx.pid;|' /etc/nginx/nginx.conf
else
  echo 'pid /run/nginx/nginx.pid;' >> /etc/nginx/nginx.conf
fi

sed -i 's/listen 80 default_server;/listen 8080 default_server;/' /etc/nginx/sites-enabled/default
sed -i 's/listen \[::\]:80 default_server;/listen [::]:8080 default_server;/' /etc/nginx/sites-enabled/default
sed -i 's/listen 80;/listen 8080;/' /etc/nginx/sites-enabled/default
sed -i 's/listen \[::\]:80;/listen [::]:8080;/' /etc/nginx/sites-enabled/default

pkill nginx || true
su -s /bin/sh -c "/usr/sbin/nginx -g 'daemon on;'" nginx

pgrep -a nginx
